apiVersion: v1
kind: ServiceAccount
metadata:
  name: image-pull
  namespace: default
  annotations:
    iam.gke.io/gcp-service-account: image-pull@portfolio-459420.iam.gserviceaccount.com
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: image-pull-secret-writer
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: image-pull-secret-writer-binding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: image-pull
    namespace: default
roleRef:
  kind: Role
  name: image-pull-secret-writer
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: refresh-gcp-pull-secret
  namespace: default
spec:
  schedule: "*/50 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: image-pull
          restartPolicy: Never
          containers:
            - name: make-secret
              image: alpine/k8s:1.30.13
              command: ["/bin/bash", "-eu", "-o", "pipefail", "-c"]
              args:
                - |
                  KSA_JWT=$(cat /var/run/secrets/tokens/ksa-jwt)

                  FED_TOKEN=$(curl -s -H "Content-Type: application/json" \
                    https://sts.googleapis.com/v1/token \
                    -d '{
                      "grantType":"urn:ietf:params:oauth:grant-type:token-exchange",
                      "requestedTokenType":"urn:ietf:params:oauth:token-type:access_token",
                      "subjectTokenType":"urn:ietf:params:oauth:token-type:jwt",
                      "audience":"//iam.googleapis.com/projects/745294108339/locations/global/workloadIdentityPools/kubernetes/providers/cluster",
                      "scope":"https://www.googleapis.com/auth/cloud-platform",
                      "subjectToken":"'"${KSA_JWT}"'"
                    }' | jq -r .access_token)

                  GSA_TOKEN=$(curl -s -H "Authorization: Bearer ${FED_TOKEN}" \
                    -H "Content-Type: application/json" \
                    "https://iamcredentials.googleapis.com/v1/projects/-/serviceAccounts/image-pull@portfolio-459420.iam.gserviceaccount.com:generateAccessToken" \
                    -d '{"scope":["https://www.googleapis.com/auth/cloud-platform"]}' | jq -r .accessToken)

                  if [[ -z "${GSA_TOKEN}" || "${GSA_TOKEN}" == "null" ]]; then
                    echo "token exchange failed" >&2
                    exit 1
                  fi

                  cat > /tmp/.dockerconfigjson <<EOF
                  {
                    "auths": {
                      "https://europe-west2-docker.pkg.dev": {
                        "username": "oauth2accesstoken",
                        "password": "${GSA_TOKEN}"
                      }
                    }
                  }
                  EOF

                  kubectl -n default create secret generic gcp-pull-secret \
                    --from-file=.dockerconfigjson=/tmp/.dockerconfigjson \
                    --type=kubernetes.io/dockerconfigjson \
                    --dry-run=client -o yaml | kubectl apply -f -
              volumeMounts:
                - name: ksa-jwt
                  mountPath: /var/run/secrets/tokens
          volumes:
            - name: ksa-jwt
              projected:
                sources:
                  - serviceAccountToken:
                      audience: "//iam.googleapis.com/projects/745294108339/locations/global/workloadIdentityPools/kubernetes/providers/cluster"
                      path: ksa-jwt
                      expirationSeconds: 3600
